<!DOCTYPE html>
<html>
    <head>
        <style>
            
            @font-face {
                font-family: DotMatrix;
                src: url(./assets/fonts/DotMatrix-TwoExtended.ttf);
            }

            body {
                background-color: rgb(59, 57, 57);
                font-family: DotMatrix;
                font-size: 21pt;
                color: rgb(126, 242, 63);
            }
            #game-window{
                width: 800px;
                height: 700px;
                background-color: black;
                margin: 0 auto;
                margin-top: 30px;
            }
            #content{
                position: relative;
                width: 96%;
                height: 675px;
                border: 0px solid white;
                border-radius: 5px;
                margin: auto;
                top: 10px;
            }
            #command-line{
                position: relative;
                width: 95%;
                height: 60px;
                border: 1px solid transparent;
                background-color: black;
                margin: auto;
                border-radius: 5px;
                top: -40px;
            }
            #prompt{
                position: relative;
                float: left;
                width: 20px;
                height: 20px;
                margin-top:3px;
                background-color: transparent;
                visibility: visible;
            }
            #text-element{
                margin-top:2px;
                padding: 2px;
                position: relative;
                float: left;
                max-width: 96%;
            }
            .message{
                display: block;
                position: absolute;
                margin-left:10px;
                padding: 0;
                border-spacing: 0;
            }
            .game-image {
                position: relative;
                width:100%;
                height: 90%;
                object-fit: cover;
            }
        </style>
    </head>
    <div id="game-window">
        <div id="content"></div>
        <div id="command-line">
            <span style="display:inline-block; letter-spacing: 1px;" id="text-element"></span>
            <div id="prompt">_</div>
        </div>
    </div>
</html>
<script>
    addEventListener("DOMContentLoaded", ()=>{
        runGame(window.document);
    });

    const runGame = (document)=>{
        let dom = document;
        let gameWindow = dom.getElementById('game-window');
        let contentElement = dom.getElementById('content');
        let commandLineElement = dom.getElementById('command-line');
        let promptElement = dom.getElementById('prompt');
        let textElement = dom.getElementById('text-element');

        const Game = {
            
            initialize: ()=>{
                Game["Variables"] = {};
                const gv = Game.Variables;
                gv.isActive = true;
                gv.command = "";
                Game.Map.initialize();
                Game.Player.initialize();
            },

            Play: {
                go: async ()=>{
                    IO.TextMode.off();
                    IO.Response.attachImage("wota-title.6", gameWindow);
                },
                runCommand: async (command)=>{
                    if (command.length == 0) return;
                    switch (`${command.toLowerCase()}`) {
 
                        case "n":
                        case "north":
                        case "go north":
                            Game.Player.move(Game.Map.Constants.Directions.North);
                            break;

                        case "s":
                        case "south":
                        case "go south":
                            Game.Player.move(Game.Map.Constants.Directions.South);
                            break;


                        case "look":
                            Game.Map.describe();
                            break;
    
                        case "run wota":
                            Game.Play.go();
                            break;

                        case "kiss chaka":
                            IO.Response.say("Yuck! Tastes like feet!");
                            IO.Response.attachImage("chaka-tear", content, 5);
                            IO.Response.playSound("chimp");
                            break;

                        case "quit":
                            IO.Response.say("Good-bye!");    
                            Game.isActive = false;
                            break;

                        case "âŽ†":
                            IO.Response.say("<br>"); 
                            break;

                        default:
                            IO.Response.say("I don't understand.<br>");
                    }
                }
            },

            Map: {
                getDirectionName: (direction)=>{
                    for(var i in Game.Map.Constants.Directions) {
                        if (Game.Map.Constants.Directions[i] == direction) return i;
                    }
                    return null;
                },
                getDirectionValue: (directionValue)=>{
                    for(var i in Game.Map.Constants.Directions) {
                        if (i == directionValue) return Game.Map.Constants.Directions[i];
                    }
                    return null;
                },
                Constants: {
                    Directions: {
                        North: 1,
                        NorthEast: 2,
                        East: 3,
                        SouthEast: 4,
                        South: 5,
                        SouthWest: 6,
                        West: 7,
                        NorthWest: 8
                    },
                    Rooms: [
                        "Cell",
                        "GuardRoom1",
                        "Supplies",
                        "Dragon",
                        "Treasure",
                        "GuardRoom2",
                        "EvilJester",
                        "Pit",
                        "MagicMirror",
                        "SnakeRoom",
                        "Cavern",
                        "QuickSand",
                        "GiantLair",
                        "Furnace",
                        "Wizard",
                        "Enchantress",
                        "Portal",
                        "Exit"
                    ],

                },
                describe:()=>{
                    IO.Response.say(Game.Player.location.baseDescription);
                    IO.Response.skipLine(); 
                },

                initialize:()=>{
                    const gm = Game.Map;
                    const makeRoom = (name, baseDescription, doorways)=>{
                        return {
                            name: name,
                            baseDescription: "",
                            doorways: doorways,
                            description: ""
                        }
                    };
                    gm["Rooms"] = gm["Rooms"] || [];
                    gm.Constants.Rooms.forEach(name=>{
                        gm[name] = makeRoom(name, "", {});
                    });
                    const dir = Game.Map.Constants.Directions;

                    gm.Cell.doorways[dir.East] = gm.GuardRoom1.name;
                    gm.Cell.doorways[dir.South] = gm.Supplies.name;
                    gm.Cell.baseDescription = "You are in a dark, smelly cell."

                    gm.GuardRoom1.doorways[dir.West] = gm.Cell.name;
                    gm.GuardRoom1.doorways[dir.South] = gm.Dragon.name;
                    gm.GuardRoom1.baseDescription = "This smallish room looks like a guard's quarters."

                    gm.Supplies.doorways[dir.North] = gm.Cell.name;
                    gm.Supplies.doorways[dir.South] = gm.Treasure.name;
                    gm.Supplies.doorways[dir.SouthEast] = gm.Dragon.name;
                    gm.Supplies.baseDescription = "This is a supplies room with a larder and sundry arms propped up against the wall.";

                    gm.Dragon.doorways[dir.North] = gm.GuardRoom1.name;
                    gm.Dragon.doorways[dir.NorthWest] = gm.Supplies.name;
                    gm.Dragon.baseDescription = "You are in an immense room with a large red dragon sleeping on a mound of gold!";

                    gm.Treasure.doorways[dir.North] = gm.Supplies.name;
                    gm.Treasure.doorways[dir.East] = gm.GuardRoom2.name;
                    gm.Treasure.baseDescription = "You find yourself in a treasure room!";

                    gm.GuardRoom2.doorways[dir.NorthEast] = gm.Wizard.name;
                    gm.GuardRoom2.doorways[dir.South] = gm.Pit.name;
                    gm.GuardRoom2.baseDescription = "This looks like another guard's quarters."
                    
                }
            },

            Player: {
                initialize:()=>{
                    const pv = Game.Player;
                    pv["location"] = Game.Map.Cell;
                    pv["inventory"] = [];
                    pv["score"] = 0;
                },
                move:(direction)=>{
                    IO.Response.say(`Go ${ Game.Map.getDirectionName(direction) }.`);
                    IO.Response.say("<br>"); 

                    let nextRoom = Game.Map[Game.Player.location.name].doorways[direction];
                    if (!nextRoom) {
                        IO.Response.say("Can't go that way.");
                        IO.Response.say("<br>"); 
                        return;
                    }
                    Game.Player.location = Game.Map[nextRoom];
                    Game.Map.describe();
                }
            },
        };

        const IO= {
            TextMode: {
                off:()=>{
                    gameWindow.innerHTML = "";
                }
            },
            Response: {
                attachImage:(pngName, el, timeout = null)=>{
                    let img = dom.createElement("img");
                    img.src = `./assets/graphics/${pngName}.png`;
                    img.className="game-image";
                    el.appendChild(img);
                    if (timeout){
                        setTimeout(()=>{
                            el.removeChild(img);
                        }, timeout * 1000);
                    };
                },
                playSound:(audioFile, el)=>{
                    var audio = new Audio(`./assets/sounds/${audioFile}.mp3`);
                    audio.play();                    
                },

                skipLine:()=>{
                    IO.Response.say("<br>");
                },
                say:(message)=>{
                    content.innerHTML = null;
                    let getMessageElement = (index, msg)=>{
                        let msgEl = dom.createElement("div");
                        msgEl.className="message";
                        msgEl.innerHTML = msg;
                        msgEl.style.bottom = `${25 * (parseInt(index) + 1)}px`;
                        return msgEl;
                    }
                    IO.Response["queue"] = IO.Response["queue"] || [];
                    if (IO.Response.queue.length >= 23) IO.Response.queue.shift();
                    IO.Response.queue.push(message);
                    let count=1;
                    for(var i = IO.Response.queue.length - 1; i >= 0; i--){
                        let message = IO.Response.queue[i];
                        let el = getMessageElement(count, message);
                        content.appendChild(el);
                        count++;
                    }
                }
            },
            Keyboard: {
                keyBlacklist: {
                    "Alt":true, 
                    "CapsLock":true, 
                    "Control": true,
                    "Escape": true,
                    "F1": true,
                    "F10": true,
                    "F11": true,
                    "F12": true,
                    "F2": true,
                    "F3": true,
                    "F4": true,
                    "F5": true,
                    "F5":true, 
                    "F6": true,
                    "F7": true,
                    "F8": true,
                    "F9": true,
                    "Shift": true, 
                    "Tab": true
                },
                handleKeyPress: (event)=>{ 
                    if (IO.Keyboard.keyBlacklist[event.key]) return;
                    let buffer = IO.Keyboard["buffer"] || "";
                    let words = buffer.split(" ");
                    let space = '\u00A0';
                    if (buffer.length + 1 >= 40 ) return;

                    switch(event.key){
                        case 'Backspace':
                            if (buffer.length == 0) return;
                            let temp = buffer.split('');
                            temp = temp.splice(-buffer.length, buffer.length-1);
                            buffer = temp.join('');
                            break;
                        
                        case 'Enter':
                            textElement.innerText = null;
                            if (buffer=="") IO.Keyboard.buffer = '\u2386';
                            Game.Play.runCommand(IO.Keyboard.buffer);
                            IO.Keyboard.buffer = null;
                            return;

                        default:
                            buffer += event.key;
                    }
                    words = buffer.split(" ");
                    IO.Keyboard.buffer = buffer;

                    textElement.innerText = words.join('\u00A0');
                },
                listen:()=>{
                    IO.Prompt.flashPrompt();
                    addEventListener("keydown", IO.Keyboard.handleKeyPress);
                }
            }, 
            CommandLine: {
                clearText: ()=>{
                    textElement.innerHTML = "";
                }
            },
            Prompt: {
                
                killPrompt: ()=>{
                    clearInterval(IO.Prompt["intervalId"]);
                    promptElement.style.visibility = "hidden";
                },

                flashPrompt: ()=>{
                    if (IO.Prompt.intervalId) clearInterval(IO.Prompt.intervalId);
                    IO.Prompt["intervalId"] = setInterval(()=>{
                        IO.Prompt["state"] = !IO.Prompt["state"];
                        promptElement.style.visibility = IO.Prompt["state"] ? "visible" : "hidden";                   
                    }, 175);
                },
            }
        };

        Game.initialize();
        IO.Keyboard.listen();
    }

</script>